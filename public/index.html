<!doctype html>
<html lang="en" x-data="setup()" x-init="init()">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <title>discuit search</title>
        <link rel="stylesheet" href="./css/catppuccin.css" />
        <link rel="stylesheet" href="./css/index.css" />
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
        ></script>
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"
        ></script>
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"
        ></script>
    </head>
    <body :class="'theme-mocha'">
        <div class="app">
            <main>
                <header class="header">
                    <div class="header-input">
                        <input
                            type="text"
                            placeholder="search..."
                            x-model="$store.search.query"
                            @input.debounce.500ms="$store.search.page = 1; search()"
                            class="search-input"
                        />
                        <!-- <div class="header-row">
              <div class="filters"></div>
              <button class="filter-button">meow</button>
            </div> -->
                    </div>
                </header>

                <div
                    class="results-view"
                    x-bind:class="{ 'loading': $store.search.fetchingResults }"
                >
                    <div class="results-container">
                        <template
                            x-if="$store.search.results.length > 0"
                            x-show="!$store.search.fetchingResults"
                        >
                            <ul class="results-list">
                                <template
                                    x-for="result in $store.search.results"
                                    :key="result.publicId"
                                >
                                    <li class="result-item">
                                        <div class="result-text">
                                            <div class="result-meta">
                                                <a
                                                    class="result-username"
                                                    x-bind:href="`https://discuit.org/@${result.username}`"
                                                >
                                                    @<span
                                                        x-text="result.username"
                                                    ></span>
                                                </a>
                                                <span>in</span>
                                                <span class="result-community">
                                                    d/<a
                                                        x-bind:href="`https://discuit.org/${result.communityName}`"
                                                        x-text="result.communityName"
                                                    ></a>
                                                </span>
                                                <span class="result-date">
                                                    â€¢
                                                    <time
                                                        x-text="new Date(result.createdAt).toLocaleDateString(navigator.language, {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                      })"
                                                    ></time>
                                                </span>
                                            </div>
                                            <div class="result-info">
                                                <h2
                                                    class="result-title"
                                                    x-html="result._formatted.title"
                                                ></h2>
                                                <template
                                                    x-if="result._formatted !== ''"
                                                >
                                                    <div
                                                        class="result-body-container"
                                                        x-data="{
                              expanded: false,
                              needsCollapse: false,
                              checkCollapse() {
                                this.$nextTick(() => {
                                  const el = this.$refs.body;
                                  if (!el) return;

                                  const lineHeight = parseFloat(getComputedStyle(el).lineHeight) || 20;
                                  const maxLines = 8;
                                  const maxHeight = lineHeight * maxLines;
                                  this.needsCollapse = el.scrollHeight > maxHeight + 1;
                                });
                              }
                            }"
                                                        x-init="checkCollapse()"
                                                        style="
                                                            position: relative;
                                                        "
                                                    >
                                                        <p
                                                            class="result-body"
                                                            :class="!expanded && needsCollapse ? 'result-body-collapsed' : ''"
                                                            x-ref="body"
                                                            x-html="renderMarkdown(result._formatted.body || '')"
                                                        ></p>
                                                        <button
                                                            x-show="needsCollapse"
                                                            @click="expanded = !expanded"
                                                            type="button"
                                                            class="show-more-btn"
                                                            x-text="expanded ? 'Show less' : 'Show more'"
                                                            :aria-expanded="expanded"
                                                        ></button>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="result-actions">
                                            <a
                                                x-bind:href="`https://discuit.org/${result.communityName}/post/${result.publicId}`"
                                                class="result-link"
                                            >
                                                view on discuit
                                            </a>
                                        </div>
                                    </li>
                                </template>
                            </ul>
                        </template>
                        <template x-if="$store.search.fetchingResults">
                            <p class="loading">loading...</p>
                        </template>
                        <template
                            x-if="$store.search.results.length === 0 && query.trim() !== ''"
                        >
                            <p class="no-results">
                                no results found for "<span
                                    x-text="query"
                                ></span
                                >"
                            </p>
                        </template>
                        <template x-if="$store.search.query.trim() === ''">
                            <p class="no-query">please enter a search term.</p>
                        </template>

                        <div
                            class="results-gradient results-gradient-top"
                        ></div>
                        <div
                            class="results-gradient results-gradient-bottom"
                        ></div>
                    </div>
                </div>

                <div class="pagination" x-data>
                    <button
                        :disabled="$store.search.page === 1"
                        @click="$store.search.page--; search()"
                    >
                        previous
                    </button>
                    <span>
                        page <span x-text="$store.search.page"></span>
                        of
                        <span
                            x-text="Math.max(1, Math.ceil($store.search.totalHits / $store.search.limit))"
                        ></span>
                    </span>
                    <button
                        :disabled="$store.search.page >= Math.ceil($store.search.totalHits / $store.search.limit)"
                        @click="$store.search.page++; search()"
                    >
                        next
                    </button>
                </div>
            </main>

            <footer class="footer">
                <div class="footer-text">
                    <h2>discuit search</h2>
                    <p>
                        a free and open source search api for discuit.org, built
                        with meilisearch, elysia & typescript, and alpine.js.
                    </p>
                    <p>
                        made with love by <a href="https://wlo.moe/">willow</a>.
                    </p>
                </div>

                <div class="footer-links">
                    <a href="https://github.com/discuit-community/search">
                        github
                    </a>
                    <a href="/privacy.md"> privacy </a>
                    <a href="/swagger"> api documentation </a>
                </div>

                <div class="footer-themes">
                    <h3>themes</h3>
                    <p>
                        using <a href="https://catppuccin.com/">catppuccin</a>!
                        a soothing pastel theme for the high-spirited.
                    </p>

                    <div class="themes-row">
                        <template
                            x-for="theme in $store.theme.themes"
                            :key="theme"
                        >
                            <button
                                :class="{ active: $store.theme.current === theme }"
                                @click="$store.theme.setTheme(theme)"
                            >
                                <span x-text="theme"></span>
                            </button>
                        </template>
                    </div>
                </div>
            </footer>
        </div>

        <script>
            function renderMarkdown(md) {
                if (!md) return "";
                return DOMPurify.sanitize(marked.parse(md));
            }

            function setup() {
                return {
                    query: "",
                    results: [],
                    fetchingResults: false,
                    renderMarkdown,

                    init() {
                        Alpine.store("search", {
                            query: "",
                            results: [],
                            fetchingResults: false,
                            page: 1,
                            limit: 20,
                            totalHits: 0,
                            init() {},
                        });

                        Alpine.store("theme", {
                            isSystem: false,
                            current: "mocha",
                            themes: [
                                "latte",
                                "frappe",
                                "macchiato",
                                "mocha",
                                "system",
                            ],

                            init() {
                                const saved = localStorage.getItem("theme");
                                if (saved) {
                                    if (saved === "system")
                                        this.setSystemTheme();
                                    else this.setTheme(saved, false);
                                } else {
                                    this.setSystemTheme();
                                }

                                window
                                    .matchMedia("(prefers-color-scheme: dark)")
                                    .addEventListener("change", (e) => {
                                        if (this.isSystem) {
                                            this.setSystemTheme();
                                        }
                                    });
                            },

                            setTheme(theme, persist = true) {
                                if (theme === "system") {
                                    this.setSystemTheme(persist);
                                    return;
                                }
                                this.isSystem = false;
                                this.current = theme;
                                if (persist)
                                    localStorage.setItem("theme", theme);
                                document.documentElement.className = `theme-${theme}`;
                            },

                            setSystemTheme(persist = true) {
                                this.isSystem = true;
                                this.current = "system";
                                if (persist)
                                    localStorage.setItem("theme", "system");
                                const isDark = window.matchMedia(
                                    "(prefers-color-scheme: dark)",
                                ).matches;
                                document.documentElement.className = isDark
                                    ? "theme-mocha"
                                    : "theme-latte";
                            },

                            toggleTheme() {
                                let idx = this.themes.indexOf(this.current);
                                idx = (idx + 1) % (this.themes.length - 1);
                                this.setTheme(this.themes[idx]);
                            },

                            reset() {
                                localStorage.removeItem("theme");
                                this.setSystemTheme();
                            },
                        });
                    },

                    search() {
                        const searchStore = Alpine.store("search");
                        const query = searchStore.query;
                        if (query.trim() === "") {
                            searchStore.results = [];
                            searchStore.totalHits = 0;
                            return;
                        }

                        searchStore.fetchingResults = true;

                        const offset =
                            (searchStore.page - 1) * searchStore.limit;

                        fetch(
                            `/search?q=${encodeURIComponent(query)}&limit=${searchStore.limit}&offset=${offset}`,
                        )
                            .then((response) => response.json())
                            .then(async (data) => {
                                searchStore.results = data.hits || [];
                                searchStore.totalHits =
                                    data.estimatedTotalHits || 0;
                            })
                            .catch((error) => {
                                console.error(
                                    "error fetching search results:",
                                    error,
                                );
                                searchStore.results = [];
                                searchStore.totalHits = 0;
                            })
                            .finally(() => {
                                searchStore.fetchingResults = false;
                            });

                        const container =
                            document.querySelector(".results-list");
                        if (container) {
                            container.scrollTo({
                                top: 0,
                                behavior: "smooth",
                            });
                        }
                    },
                };
            }

            document.addEventListener("alpine:initialized", () => {
                Alpine.data("setup", setup);
            });

            document.addEventListener("DOMContentLoaded", () => {
                const parent = document.querySelector(".results-container");
                if (!parent) return;

                function setupResultsList(container) {
                    function updateItemRadii() {
                        const items =
                            container.querySelectorAll(".result-item");
                        const containerRect = container.getBoundingClientRect();

                        const maxDistance = 128;
                        const minRadius = 0.5;
                        const maxRadius = 2.7;

                        for (const item of items) {
                            const itemRect = item.getBoundingClientRect();

                            const distanceTop =
                                itemRect.top - containerRect.top;
                            const distanceBottom =
                                containerRect.bottom - itemRect.bottom;

                            let topRadius = minRadius;
                            // if the item's top is within maxDistance from the container's
                            //   top, interpolate the top border radius between maxRadius and
                            //   minRadius
                            if (
                                distanceTop >= 0 &&
                                distanceTop <= maxDistance
                            ) {
                                topRadius =
                                    maxRadius -
                                    (maxRadius - minRadius) *
                                        (distanceTop / maxDistance);
                            } else if (distanceTop < 0) {
                                topRadius = maxRadius;
                            }

                            let bottomRadius = minRadius;
                            // if the item's bottom is within maxDistance from the
                            //   container's bottom, similarly interpolate the bottom border
                            //   radius
                            if (
                                distanceBottom >= 0 &&
                                distanceBottom <= maxDistance
                            ) {
                                bottomRadius =
                                    maxRadius -
                                    (maxRadius - minRadius) *
                                        (distanceBottom / maxDistance);
                            } else if (distanceBottom < 0) {
                                bottomRadius = maxRadius;
                            }

                            item.style.setProperty(
                                "--item-top-radius",
                                `${topRadius}rem`,
                            );
                            item.style.setProperty(
                                "--item-bottom-radius",
                                `${bottomRadius}rem`,
                            );
                        }
                    }

                    container.addEventListener("scroll", updateItemRadii);
                    window.addEventListener("resize", updateItemRadii);

                    const observer = new MutationObserver(() =>
                        setTimeout(updateItemRadii, 10),
                    );
                    observer.observe(container, {
                        childList: true,
                        subtree: true,
                    });

                    setTimeout(updateItemRadii, 50);
                }

                const observer = new MutationObserver((mutations, obs) => {
                    const container = parent.querySelector(".results-list");
                    if (container) {
                        setupResultsList(container);
                        obs.disconnect();
                    }
                });

                observer.observe(parent, { childList: true, subtree: true });

                const container = parent.querySelector(".results-list");
                if (container) {
                    setupResultsList(container);
                    observer.disconnect();
                }
            });
        </script>
    </body>
</html>
