<!doctype html>
<html lang="en" x-data="setup()" x-init="init()">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>discuit search</title>
    <link rel="stylesheet" href="./css/catppuccin.css" />
    <link rel="stylesheet" href="./css/index.css" />
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
  </head>
  <body :class="'theme-mocha'">
    <div class="app">
      <main>
        <header class="header">
          <div class="header-input">
            <input
              type="text"
              placeholder="search..."
              x-model="$store.search.query"
              @input.debounce.500ms="$store.search.page = 1; search()"
              class="search-input"
            />
            <!-- <div class="header-row">
              <div class="filters"></div>
              <button class="filter-button">meow</button>
            </div> -->
          </div>
        </header>

        <div
          class="results-view"
          x-bind:class="{ 'loading': $store.search.fetchingResults }"
        >
          <div class="results-container">
            <template x-if="$store.search.results.length > 0">
              <ul class="results-list">
                <template
                  x-for="result in $store.search.results"
                  :key="result.publicId"
                >
                  <li class="result-item">
                    <div class="result-text">
                      <div class="result-meta">
                        <a
                          class="result-username"
                          x-bind:href="`https://discuit.org/@${result.username}`"
                        >
                          @<span x-text="result.username"></span>
                        </a>
                        <span>in</span>
                        <span class="result-community">
                          d/<a
                            x-bind:href="`https://discuit.org/${result.communityName}`"
                            x-text="result.communityName"
                          ></a>
                        </span>
                        <span class="result-date">
                          •
                          <time
                            x-text="new Date(result.createdAt).toLocaleDateString(navigator.language, {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                      })"
                          ></time>
                        </span>
                      </div>
                      <div class="result-info">
                        <h2
                          class="result-title"
                          x-html="result._formatted.title"
                        ></h2>
                        <template x-if="result._formatted !== ''">
                          <p
                            class="result-body"
                            x-html="result._formatted.body || ''"
                          ></p>
                        </template>
                      </div>
                    </div>
                    <div class="result-actions">
                      <a
                        x-bind:href="`https://discuit.org/${result.communityName}/post/${result.publicId}`"
                        class="result-link"
                      >
                        view on discuit
                      </a>
                    </div>
                  </li>
                </template>
              </ul>
            </template>
            <template x-if="$store.search.fetchingResults">
              <p class="loading">loading...</p>
            </template>
            <template
              x-if="$store.search.results.length === 0 && query.trim() !== ''"
            >
              <p class="no-results">
                no results found for "<span x-text="query"></span>"
              </p>
            </template>
            <template x-if="$store.search.query.trim() === ''">
              <p class="no-query">please enter a search term.</p>
            </template>
          </div>
        </div>

        <div class="pagination" x-data>
          <button
            :disabled="$store.search.page === 1"
            @click="$store.search.page--; search()"
          >
            previous
          </button>
          <span>
            page <span x-text="$store.search.page"></span>
            of
            <span
              x-text="Math.max(1, Math.ceil($store.search.totalHits / $store.search.limit))"
            ></span>
          </span>
          <button
            :disabled="$store.search.page >= Math.ceil($store.search.totalHits / $store.search.limit)"
            @click="$store.search.page++; search()"
          >
            next
          </button>
        </div>
      </main>

      <footer class="footer">
        <div class="footer-text">
          <h2>discuit search</h2>
          <p>
            a free and open source search api for discuit.org, built with
            meilisearch, elysia & typescript, and alpine.js.
          </p>
          <p>made with love by <a href="https://wlo.moe/">willow</a>.</p>
        </div>

        <div class="footer-links">
          <a href="https://github.com/discuit-community/search"> github </a>
          <a href="/swagger"> api documentation </a>
        </div>
      </footer>
    </div>

    <script>
      function setup() {
        return {
          query: "",
          results: [],
          fetchingResults: false,
          init() {
            Alpine.store("search", {
              query: "",
              results: [],
              fetchingResults: false,
              page: 1,
              limit: 20,
              totalHits: 0,
              init() {},
            });
          },

          search() {
            const searchStore = Alpine.store("search");
            const query = searchStore.query;
            if (query.trim() === "") {
              searchStore.results = [];
              searchStore.totalHits = 0;
              return;
            }

            searchStore.fetchingResults = true;

            const offset = (searchStore.page - 1) * searchStore.limit;

            fetch(
              `/search?q=${encodeURIComponent(query)}&limit=${searchStore.limit}&offset=${offset}`,
            )
              .then((response) => response.json())
              .then(async (data) => {
                await new Promise((resolve) => setTimeout(resolve, 500));
                searchStore.results = data.hits || [];
                searchStore.totalHits = data.estimatedTotalHits || 0;
                searchStore.fetchingResults = false;
              })
              .catch((error) => {
                console.error("error fetching search results:", error);
                searchStore.fetchingResults = false;
                searchStore.results = [];
                searchStore.totalHits = 0;
              });
          },
        };
      }

      document.addEventListener("alpine:initialized", () => {
        Alpine.data("setup", setup);
        const searchStore = Alpine.store("search");

        searchStore.query = "meow";
        searchStore.fetchingResults = false;
        searchStore.results = [
          {
            publicId: "3oGrwwEJ",
            createdAt: "2025-06-15T14:32:22Z",
            title: "A cozy Creamie",
            body: null,
            communityName: "Cats",
            username: "godzilla_lives",
            type: "image",
            hotness: 388906493355,
            upvotes: 20,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "3oGrwwEJ",
              createdAt: "2025-06-15T14:32:22Z",
              title: "A cozy Creamie",
              body: null,
              communityName: "Cats",
              username: "godzilla_lives",
              type: "image",
              hotness: "388906493355",
              upvotes: "20",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "cB5GAUxe",
            createdAt: "2025-06-15T14:31:13Z",
            title: "The gang does Father's Day",
            body: null,
            communityName: "Cats",
            username: "qwexer",
            type: "image",
            hotness: 388907108539,
            upvotes: 22,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "cB5GAUxe",
              createdAt: "2025-06-15T14:31:13Z",
              title: "The gang does Father's Day",
              body: null,
              communityName: "Cats",
              username: "qwexer",
              type: "image",
              hotness: "388907108539",
              upvotes: "22",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "cEw4fKqe",
            createdAt: "2025-06-14T23:09:29Z",
            title: "PAWS UP!!",
            body: null,
            communityName: "Cats",
            username: "wkdpaul",
            type: "image",
            hotness: 388896695493,
            upvotes: 30,
            downvotes: 1,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "cEw4fKqe",
              createdAt: "2025-06-14T23:09:29Z",
              title: "PAWS UP!!",
              body: null,
              communityName: "Cats",
              username: "wkdpaul",
              type: "image",
              hotness: "388896695493",
              upvotes: "30",
              downvotes: "1",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "0OalqD8v",
            createdAt: "2025-06-14T00:14:28Z",
            title: "The way I wanna go",
            body: null,
            communityName: "Cats",
            username: "theBees",
            type: "image",
            hotness: 388877749241,
            upvotes: 27,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "0OalqD8v",
              createdAt: "2025-06-14T00:14:28Z",
              title: "The way I wanna go",
              body: null,
              communityName: "Cats",
              username: "theBees",
              type: "image",
              hotness: "388877749241",
              upvotes: "27",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "ISuG5MU4",
            createdAt: "2025-06-13T04:21:45Z",
            title: "The bois crossing tails while they monch on snacc",
            body: null,
            communityName: "Cats",
            username: "NanaRex",
            type: "image",
            hotness: 388862459049,
            upvotes: 30,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "ISuG5MU4",
              createdAt: "2025-06-13T04:21:45Z",
              title: "The bois crossing tails while they monch on snacc",
              body: null,
              communityName: "Cats",
              username: "NanaRex",
              type: "image",
              hotness: "388862459049",
              upvotes: "30",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "5JkZ9DrB",
            createdAt: "2025-06-12T19:56:47Z",
            title: "How am I supposed to make the bed Suki?",
            body: null,
            communityName: "Cats",
            username: "godzilla_lives",
            type: "image",
            hotness: 388856740736,
            upvotes: 36,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "5JkZ9DrB",
              createdAt: "2025-06-12T19:56:47Z",
              title: "How am I supposed to make the bed Suki?",
              body: null,
              communityName: "Cats",
              username: "godzilla_lives",
              type: "image",
              hotness: "388856740736",
              upvotes: "36",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "R8zBn5ZQ",
            createdAt: "2025-06-12T15:55:55Z",
            title: "the coziest snugglebug",
            body: null,
            communityName: "Cats",
            username: "asukii",
            type: "image",
            hotness: 388853051453,
            upvotes: 33,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "R8zBn5ZQ",
              createdAt: "2025-06-12T15:55:55Z",
              title: "the coziest snugglebug",
              body: null,
              communityName: "Cats",
              username: "asukii",
              type: "image",
              hotness: "388853051453",
              upvotes: "33",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "YzsFb1_J",
            createdAt: "2025-06-11T14:08:37Z",
            title: "He has not received a single touch ever in his whole life.",
            body: null,
            communityName: "Cats",
            username: "Hairballrelief",
            type: "image",
            hotness: 388833328860,
            upvotes: 39,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "YzsFb1_J",
              createdAt: "2025-06-11T14:08:37Z",
              title:
                "He has not received a single touch ever in his whole life.",
              body: null,
              communityName: "Cats",
              username: "Hairballrelief",
              type: "image",
              hotness: "388833328860",
              upvotes: "39",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "6fbMDvWi",
            createdAt: "2025-06-10T16:58:29Z",
            title:
              "Bean's water dish is in the washer, so my wife put out a water mug instead. ",
            body: null,
            communityName: "Cats",
            username: "flibbertygibbit",
            type: "image",
            hotness: 388813873678,
            upvotes: 25,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "6fbMDvWi",
              createdAt: "2025-06-10T16:58:29Z",
              title:
                "Bean's water dish is in the washer, so my wife put out a water mug instead. ",
              body: null,
              communityName: "Cats",
              username: "flibbertygibbit",
              type: "image",
              hotness: "388813873678",
              upvotes: "25",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "ZIApeD7B",
            createdAt: "2025-06-10T14:28:59Z",
            title: "The puff is gruff.",
            body: null,
            communityName: "Cats",
            username: "Hairballrelief",
            type: "image",
            hotness: 388812760709,
            upvotes: 29,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "ZIApeD7B",
              createdAt: "2025-06-10T14:28:59Z",
              title: "The puff is gruff.",
              body: null,
              communityName: "Cats",
              username: "Hairballrelief",
              type: "image",
              hotness: "388812760709",
              upvotes: "29",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "fhMUIwVH",
            createdAt: "2025-06-09T02:57:52Z",
            title: "Oh! Biiiiig yawn! ",
            body: null,
            communityName: "Cats",
            username: "Ealasaid",
            type: "image",
            hotness: 388784905772,
            upvotes: 32,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "fhMUIwVH",
              createdAt: "2025-06-09T02:57:52Z",
              title: "Oh! Biiiiig yawn! ",
              body: null,
              communityName: "Cats",
              username: "Ealasaid",
              type: "image",
              hotness: "388784905772",
              upvotes: "32",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "jWUvldeC",
            createdAt: "2025-06-08T15:51:16Z",
            title:
              "I tried to get a picture of them napping together, but apparently I'm not sneaky enough. ",
            body: null,
            communityName: "Cats",
            username: "Shoe",
            type: "image",
            hotness: 388778222228,
            upvotes: 47,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "jWUvldeC",
              createdAt: "2025-06-08T15:51:16Z",
              title:
                "I tried to get a picture of them napping together, but apparently I'm not sneaky enough. ",
              body: null,
              communityName: "Cats",
              username: "Shoe",
              type: "image",
              hotness: "388778222228",
              upvotes: "47",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "0VyR0XjR",
            createdAt: "2025-06-08T13:27:16Z",
            title:
              "Cat was not pleased she could not reach this little visitor. ",
            body: null,
            communityName: "Cats",
            username: "Shoe",
            type: "image",
            hotness: 388773537821,
            upvotes: 29,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "0VyR0XjR",
              createdAt: "2025-06-08T13:27:16Z",
              title:
                "Cat was not pleased she could not reach this little visitor. ",
              body: null,
              communityName: "Cats",
              username: "Shoe",
              type: "image",
              hotness: "388773537821",
              upvotes: "29",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "o830YPNy",
            createdAt: "2025-06-07T21:11:59Z",
            title: "Loungin'",
            body: null,
            communityName: "Cats",
            username: "Shoe",
            type: "image",
            hotness: 388761891640,
            upvotes: 37,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "o830YPNy",
              createdAt: "2025-06-07T21:11:59Z",
              title: "Loungin'",
              body: null,
              communityName: "Cats",
              username: "Shoe",
              type: "image",
              hotness: "388761891640",
              upvotes: "37",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "H5pjx_08",
            createdAt: "2025-06-07T20:57:30Z",
            title: "My hoomin won’t let me eat flowers",
            body: null,
            communityName: "Cats",
            username: "Avocado8",
            type: "image",
            hotness: 388762421793,
            upvotes: 42,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "H5pjx_08",
              createdAt: "2025-06-07T20:57:30Z",
              title: "My hoomin won’t let me eat flowers",
              body: null,
              communityName: "Cats",
              username: "Avocado8",
              type: "image",
              hotness: "388762421793",
              upvotes: "42",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "CIe68Vds",
            createdAt: "2025-06-07T17:13:15Z",
            title: "A serene Peanut",
            body: null,
            communityName: "Cats",
            username: "godzilla_lives",
            type: "image",
            hotness: 388758560292,
            upvotes: 36,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "CIe68Vds",
              createdAt: "2025-06-07T17:13:15Z",
              title: "A serene Peanut",
              body: null,
              communityName: "Cats",
              username: "godzilla_lives",
              type: "image",
              hotness: "388758560292",
              upvotes: "36",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "GFK44fCA",
            createdAt: "2025-06-07T02:24:20Z",
            title: "Shhhhhh",
            body: null,
            communityName: "Cats",
            username: "Ealasaid",
            type: "image",
            hotness: 388746395492,
            upvotes: 34,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "GFK44fCA",
              createdAt: "2025-06-07T02:24:20Z",
              title: "Shhhhhh",
              body: null,
              communityName: "Cats",
              username: "Ealasaid",
              type: "image",
              hotness: "388746395492",
              upvotes: "34",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "877Vd6ZQ",
            createdAt: "2025-06-06T20:48:08Z",
            title:
              "Cats recognize familiar BO and can spot strangers from the stink of their armpits and toes",
            body: null,
            communityName: "Cats",
            username: "HamboneDK",
            type: "link",
            hotness: 388741747675,
            upvotes: 33,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "877Vd6ZQ",
              createdAt: "2025-06-06T20:48:08Z",
              title:
                "<span class='highlight'>Cats</span> recognize familiar BO and can spot strangers from the stink of their armpits and toes",
              body: null,
              communityName: "Cats",
              username: "HamboneDK",
              type: "link",
              hotness: "388741747675",
              upvotes: "33",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "zN4mf3yq",
            createdAt: "2025-06-06T16:03:07Z",
            title: "You know what...",
            body: null,
            communityName: "Cats",
            username: "wkdpaul",
            type: "image",
            hotness: 388739583134,
            upvotes: 44,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "zN4mf3yq",
              createdAt: "2025-06-06T16:03:07Z",
              title: "You know what...",
              body: null,
              communityName: "Cats",
              username: "wkdpaul",
              type: "image",
              hotness: "388739583134",
              upvotes: "44",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
          {
            publicId: "hAvSaR_B",
            createdAt: "2025-06-06T03:29:39Z",
            title: "My priced shot of the month ",
            body: null,
            communityName: "Cats",
            username: "missing",
            type: "image",
            hotness: 388726526612,
            upvotes: 26,
            downvotes: 0,
            isPinned: 0,
            deleted: 0,
            _formatted: {
              publicId: "hAvSaR_B",
              createdAt: "2025-06-06T03:29:39Z",
              title: "My priced shot of the month ",
              body: null,
              communityName: "Cats",
              username: "missing",
              type: "image",
              hotness: "388726526612",
              upvotes: "26",
              downvotes: "0",
              isPinned: "0",
              deleted: "0",
            },
          },
        ];
      });

      document.addEventListener("DOMContentLoaded", () => {
        const container = document.querySelector(".results-list");
        if (!container) return;

        function updateItemRadii() {
          const items = container.querySelectorAll(".result-item");
          const containerRect = container.getBoundingClientRect();

          const maxDistance = 128;
          const minRadius = 0.5;
          const maxRadius = 2.7;

          items.forEach((item) => {
            const itemRect = item.getBoundingClientRect();

            const distanceTop = itemRect.top - containerRect.top;
            const distanceBottom = containerRect.bottom - itemRect.bottom;

            let topRadius = minRadius;
            if (distanceTop >= 0 && distanceTop <= maxDistance) {
              topRadius =
                maxRadius -
                (maxRadius - minRadius) * (distanceTop / maxDistance);
            }

            let bottomRadius = minRadius;
            if (distanceBottom >= 0 && distanceBottom <= maxDistance) {
              bottomRadius =
                maxRadius -
                (maxRadius - minRadius) * (distanceBottom / maxDistance);
            }

            item.style.setProperty("--item-top-radius", `${topRadius}rem`);
            item.style.setProperty(
              "--item-bottom-radius",
              `${bottomRadius}rem`,
            );
          });
        }

        container.addEventListener("scroll", updateItemRadii);
        window.addEventListener("resize", updateItemRadii);

        const observer = new MutationObserver(() =>
          setTimeout(updateItemRadii, 10),
        );
        observer.observe(container, { childList: true, subtree: true });

        setTimeout(updateItemRadii, 50);
      });
    </script>
  </body>
</html>
